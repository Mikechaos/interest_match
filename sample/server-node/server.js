// Generated by CoffeeScript 1.6.1
(function(){var e;Number.prototype.toRad=function(){return this*Math.PI/180};e={io:null,redisWorker:null,httpServer:null,fs:null,clients:{objects:{},usernameMap:{},socketMap:{},subscribers:{},subscribees:{}},config:{port:8081,redisHost:"127.0.0.1",redisPort:6379},init:function(t){t!=null&&(this.config=this._mergeOptions(this.config(t)));this.fs=require("fs");this.httpServer=require("http").createServer(this._handleHttpRequest);this.httpServer.listen(this.config.port);this.io=require("socket.io").listen(this.httpServer);this.io.set("log level",1);return this.io.sockets.on("connection",function(t){console.log("CONNECTED");t.on("authenticate",function(n){var r,i;i={authenticated:!0,usernameTaken:!1};if(n!=null&&n.token!=null){i.usernameTaken=e.getClient(n.token)===!1&&e._validateUsername(n!=null&&n.username!=null?n.username:null);r=!0;try{i.usernameTaken||(e.clients.objects[n.token]=e._createClient(t,n!=null?n:null));r=!1}catch(s){console.log(s.message)}if(r){console.log("close socket");t.disconnect();return}return t.emit("authenticateResponse",i)}});t.on("message",function(n){var r,i;console.log("RECEIVED MESSAGE",n);r=e.getClientBySocket(t);i={type:"message",username:r.username,message:n.content,mention:!1};return e.sendUpdate(r,i)});return t.on("update",function(n){var r;r=e.getClientBySocket(t.id);if(r){n.location!=null&&(r.location=n.location);n.radius!=null&&(r.radius=n.radius);e._updateSubscribers(r,"local");return e._updateSubscribers(r,"remote")}})})},sendUpdate:function(t,n,r){var i,s;r==null&&(r="remote");if(r==="remote"){s=[];for(i in e.clients.subscribers[t.deviceToken])try{if(n!=null&&n.type!=null&&n.type==="message"){n.mention=!1;(0+n.message.toLowerCase()+" ").indexOf("@"+t.username.toLowerCase())&&(n.mention=!0)}e.clients.objects[i].socket.emit("update",n);s.push(console.log(t.deviceToken,"sending to",i))}catch(o){}return s}try{return t.socket.emit("update",n)}catch(o){return console.log(o.message)}},_updateSubscribers:function(t,n){var r,i,s,o,u,a,f;n==null&&(n="local");s={};r=0;u={latitude:t.location[0],longitude:t.location[1]};a=[];for(f in e.clients.objects){try{if(e.clients.objects[f].username!=null){i=e._calculateDistance(u,{latitude:e.clients.objects[f].location[0],longitude:e.clients.objects[f].location[1]});if(i<0||i>(n==="local"?t.radius:e.clients.objects[f].radius))continue;n==="local"&&a.push(e.clients.objects[f].username);++r;s[f]=!0}}catch(l){console.log(l.message)}if(n==="local"){e.clients.subscribers[t.deviceToken]=s;e.sendUpdate(t,{type:"subscribers-list",list:a})}else{try{for(o in e.clients.subscribees[t.deviceToken])try{e.clients.subscribers[o][t.deviceToken]=null}catch(c){}}catch(c){}for(o in s){console.log(o,n);e.clients.subscribers[o][t.token]=!0}e.clients.subscribees[t.deviceToken]=s}}return r},getClientBySocket:function(t){try{if(t!=null&&e.clients.socketMap[t.id!=null?t.id:t]!=null)return e.clients.objects[e.clients.socketMap[t.id!=null?t.id:t]]}catch(n){}return!1},getClient:function(t){try{return t!=null&&e.clients.objects[t]!=null?e.clients.objects[t]:!1}catch(n){}return!1},_validateUsername:function(t){return e.clients.usernameMap[t]!=null},deleteClient:function(t){var n;if(t==null)return!1;n=e.getClient(t);if(n){try{n.socket.disconnect()}catch(r){}try{n.username!=null&&(e.clients.usernameMap[n.username]=null);e.clients.socketMap[n.id]=null;e.clients.objects[n.token]=null;return!0}catch(i){}}return!1},_createClient:function(t,n){var r;r={id:t.id,socket:t,location:n.location,username:n.username,deviceToken:n.token,authenticated:!0,radius:n.radius};e.clients.objects[n.token]=r;e.clients.usernameMap[r.username]=n.token;e.clients.socketMap[r.id]=n.token;e._updateSubscribers(r,"local");e._updateSubscribers(r,"remote");return r},_handleHttpRequest:function(t,n){return e.fs.readFile(__dirname+t.url.split("?")[0],function(e,t){if(e){n.writeHead("500");return n.end("Error loading index.html")}n.writeHead("200");return n.end(t)})},_calculateDistance:function(e,t){var n,r,i,s,o,u,a,f,l,c;try{a=e.latitude;f=t.latitude;l=e.longitude;c=t.longitude;n=6371;o=(f-a).toRad();u=(c-l).toRad();a=a.toRad();f=f.toRad();r=Math.sin(o/2)*Math.sin(o/2)+Math.sin(u/2)*Math.sin(u/2)*Math.cos(a)*Math.cos(f);i=2*Math.atan2(Math.sqrt(r),Math.sqrt(1-r));s=n*i;return s*1e3}catch(h){}return-1},_mergeOptions:function(e,t){var n,r;r={};for(n in e)r[n]=e[n];for(n in t)r[n]=t[n];return r}};e.init()}).call(this);