// Generated by CoffeeScript 1.6.1
(function(){var e,t,n,r,i,s,o;e=window.jQuery;n=window.Backbone;o=window._;i=window.io;window.app={debug:!0,user:{authenticate:!1}};r=window.app;o.extend(r,n.Events);s=function(){return document.URL.indexOf("file://")===0?!0:!1};window.phoneGap=s();r.ready=function(t){var n,i,s,o;if(window.phoneGap){r.socket.config.username=t;r.socket.config.token=device.uuid;i=function(e){r.socket.config.position=[e.coords.longitude,e.coords.latitude];return r.socket.connect()};n=function(t){e(".alert.localisation").slideDown(500);r.analytics.event("error/no_position");return e("input.username").removeAttr("disabled")};return navigator.geolocation.getCurrentPosition(i,n)}r.socket.config.username=t;s=String.fromCharCode(65+Math.floor(Math.random()*26));o=s+Date.now();r.socket.config.token="broswer-"+o;r.socket.config.position=[45.5081,73.555];return r.socket.connect()};r.init=function(){r.user.init();r.message.init();n.history.start();r.socket.init();return r.analytics.event("session/new")};r.socket={engine:null,config:{init:!1,radius:5e3,username:null,token:null,position:null,notifyOnMention:!0,isConnected:!1,socketEndpoint:"http://getnightowl.com:8080"},init:function(){this.engine=i.connect(this.config.socketEndpoint);this.engine.on("connect",function(e){return r.analytics.event("session/connect")});this.engine.on("authenticateResponse",function(t){console.log(t);if(t.usernameTaken){e(".alert.already-use").slideDown(500);e("input.username").removeAttr("disabled");e("input.username").val("");return e("input.username").focus()}r.user.authenticate=!0;window.location="#message";return r.analytics.event("session/authenticate")});this.engine.on("update",function(e){return r.trigger(e.type,e)});return this.engine.on("disconnect",function(e){r.user.authenticate=!1;r.analytics.event("session/disconnect");return window.location="#"})},connect:function(){r.user={username:r.socket.config.username,token:r.socket.config.token,location:r.socket.config.position,authenticate:!1};return r.socket.push("authenticate",r.user)},push:function(e,t){r.socket.engine.emit(e,t);r.analytics.event("push/"+e);return console.log(t)}};r.db={db:null,getNewGuid:function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){var t,n,r;t=Math.random()*16|0;n=(r=e==="x")!=null?r:{r:t&3|8};return n.toString(16)})},init:function(){var e;console.log("TEST");e=r.db.getNewGuid();alert("guid ->"+e);r.db.db=window.openDatabase("device_info","1.0","Test DB",30720);return r.db.db.transaction(function(t){t.executeSql("CREATE TABLE IF NOT EXISTS deice_info (`key` unique, `value`)");return t.executeSql('INSERT INFO device_info(`key`, `value`) VALUES("device_token", '+e+'")')})}};r.analytics={event:function(e,t){_gaq.push(["_trackPageview","/event/"+e]);if(r.debug)return console.log("Event: "+e)}};e(function(){var t;e("input.username").keyup(function(e){var n;n=e.keyCode||e.which;console.log(n);if(n===13)return t()});e(".btn.join").click(function(e){return t()});return t=function(){var t;t=e("input.username").val();t=t.replace(/^\s+|\s+$/g,"");e(".alert").hide(0);if(t){e("input.username").attr("disabled","disabled");return r.ready(t)}return e(".alert.empty").slideDown(500)}});r.user={count:0,selector:{user_list:null},init:function(){this.selector.user_list=e("ul.user-list");r.on("subscribers-list",r.user.add);return this},add:function(t){var n,i,s,o,u,a,f;n=r.user;e(".user.count").text(t.list.length);i=e("ul.user-list");i.html("");a=t.list;f=[];for(o=0,u=a.length;o<u;o++){s=a[o];f.push(i.append("<li>"+s+"</li>"))}return f}};e(function(){e("input.message-creator").keyup(function(t){var n,i,s;i=t.keyCode||t.which;n=e(this);if(i===13){s=n.val();if(s){n.val("");n.focus();return r.message.create(s)}}});return e(".message-list").on("click",function(t){e(".message-creator").val("@"+e(".username",e(this)).first().text()+": ");return e(".message-creator").focus()})});r.message={count:0,selector:{message_list:null},init:function(){this.selector.message_list=e("ul.message-list.regular");return r.on("message",r.message.add)},add:function(t){var n,i;n=r.message;n.count++;e(".message.count").text(n.count);i=window.moment().format("h:mm");n.selector.message_list.prepend("<li><span class='message'>"+e("<div/>").text(t.message).html()+("</span><span class='time'>"+i+"</span><br/><span class='username'>")+e("<div/>").text(t.username).html()+"</span></li>");e("input.message-creator").blur();return window.scrollTo(0,0)},create:function(e){return r.socket.push("message",{content:e,type:"text"})}};e(function(){e("#settings_selection").on("change",function(t){return e("#"+e(this).val()).focus()});return e("#radius_selection").on("change",function(t){return r.zoom.update(e(this).val())})});r.zoom={update:function(e){return r.socket.push("update",{radius:e})}};r.localisation={update:function(e,t){return r.socket.push("update",[e,t])}};t=n.Router.extend({routes:{user:"user",message:"message",bid:"bid","*actions":"default"},showPage:function(t){var n;e(".page").hide(0);e("#content-"+t).show(0);e("footer [data-item-uid]").removeClass("active");e("footer [data-item-uid="+t+"]").addClass("active");n=e("body").attr("data-loaded-class");e("body").removeClass("page-"+n);e("body").attr("data-loaded-class",t);e("body").addClass("page-"+t);r.analytics.event("page/"+t);if(t==="home")return e("input.username").focus()}});r.controller=new t;r.controller.on("route:default",function(e){return r.user.authenticate?r.controller.showPage("message"):r.controller.showPage("home")});r.controller.on("route:user",function(e){return r.user.authenticate?r.controller.showPage("user"):r.controller.showPage("home")});r.controller.on("route:message",function(e){return r.user.authenticate?r.controller.showPage("message"):r.controller.showPage("home")});r.controller.on("route:bid",function(e){return r.user.authenticate?r.controller.showPage("bid"):r.controller.showPage("home")})}).call(this);